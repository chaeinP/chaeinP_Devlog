---
title: JavaScript_싱글 스레드와 이벤트 루프
date: '2021-09-19'
tags: ['JavaScript']
draft: false
summary: 자바스크립트, node js는 싱글 스레드인가?
---

## 자바스크립트는 싱글 스레드 언어인가?

그렇다. 스레드란 코드를 읽는 실행 단위를 의미한다. 자바스크립트가 싱글 스레드 언어라고 불리는 이유는 브라우저나 nodejs가 자바스크립트를 실행시키는 작동원리에서 찾을 수 있다.

### 자바스크립트 작동 원리

자바스크립트를 실행시키기 위해서는 실행 환경이 필요하다. nodejs나 브라우저가 이러한 환경에 해당된다. 브라우저에서 자바스크립트가 작동하는 과정을 표현하면 다음과 같다. 이러한 작동 원리를 이벤트 루프라고 한다.
![이벤트 루프](https://miro.medium.com/max/1600/1*i9nTlOSPH3q-sCd5-WHg-g.png)

- Memory Heap : 참조형 데이터를 저장하는 곳이다. 더이상 참조되지 않는 데이터는 가비지 컬렉터에 의해 수거된다.
- Call Stack : 원시형 데이터와 Memory Heap을 참조하는 변수들을 저장하고 실행한다. 실행된 명령들은 실행 직후 제거된다.
- Web APIs : 자바스크립트 혹은 더 넓은 범위로 웹 관련 기술을 지원하는 인터페이스의 모음.
- Callback Queue : 콜백 큐, Web API에서 처리가 끝난 후 실행 되어야 하는 Callback(Task)이 순차적으로 쌓이는 자료 구조.
- Event Loop : Call Stack이 비어있을 때 Callback Queue 데이터를 선입선출에 의해 Call Stack으로 이동시킨다.

자바스크립트가 싱글 스레드라고 불리는 이유는 단 하나의 콜 스택에서만 코드가 실행되기 때문이다. 싱글 스레드임에도 불구하고 병렬적으로 처리되는 것처럼 실행되는 이유는 이벤트 루프가 코드를 비동기적으로 처리하기 때문이다.

이처럼 싱글 스레드로 작동했을 때 장점은 무엇일까?

## 싱글 스레드의 장점

- 자원 접근에 대한 동기화를 신경쓰지 않아도 된다.

  멀티 스레드의 경우 여러개의 스택이 하나의 heap을 공유하게 된다. 이 때 복수의 스택이 heap에 있는 하나의 데이터를 동시에 변경시키는 경우 개발자가 예상하지 못한 에러가 발생할 수 있다. 실제로 멀티스레드를 구현하는 것은 개발자에게 굉장히 까다로운 작업이다.

- 문맥 교환 비용이 발생하지 않는다.

  문맥 교환 비용은 작업이 전환될 때 작업 진행에 필요한 데이터들이 교체될때 발생하는 비용을 의미한다. 단일 스레드는 스레드간 작업 교체가 발생하지 않기 때문에 문맥 교환 비용도 발생하지 않는다.

그러나 자바스크립트의 비동기는 다른 언어에서 쉽게 볼 수 없는 작동 방식이라 익숙해지는데 시간이 필요하고 또 큰 연산이 필요한 무거운 작업의 경우 막힘없이 비동기 작업이 처리되도록 코드를 짜는 것 또한 쉽지 않은 일이다. 이에 따라 자바스크립트를 멀티 스레드 방식처럼 구현할 수 있는 새로운 Web Api가 등장했다.

## 자바스크립트의 싱글 스레드를 보완하는 웹워커(Web worker)

웹워커는 웹 워커(Web Worker)는 Mozilla 재단과 구글이 협력해 만든 새로운 Web API이다. 개인적으론 웹워커는 멀티 스레드 방식보단 멀티 프로세스 방식이라고 보는것이 정확하지 않을까 싶다. 웹 워커는 코어의 개수에 따라 여러개의 스레드가 동시에 실행되지만 사실 각 프로세스 안에는 단 하나의 스레드만 존재하고 여러개가 동시에 동작하는 것은 프로세스 이므로 멀티 프로세스 싱글 스레드 방식이 정확한 표현이라고 생각한다. 그런데 보통은 그냥 멀티 스레드라고 하는 것 같더라...(개인적 의견)

브라우저는 탭마다 하나의 스레드를 생성한다. 자바스크립트는 이 싱글 스레드에서 동작하는데 웹 워커는 이 스레드와는 별개로 브라우저 단에서 새로운 스레드를 실행시킨다. 그리고 메인 스레드와 웹워커가 돌아가는 스레드는 서로 이벤트를 발생 시켜 커뮤니케이션 한다. 웹워커를 이용하면 싱글 스레드로 인한 단점을 보완할 수 있다.

## node js도 싱글 스레드일까?

답변은 질문을 해석하는 시각에 따라 맞을 수도, 아닐수도 있다. 웹브라우저가 자바스크립트는 싱글 스레드로만 실행시키지만 동시에 여러개의 프로세스로 멀티 스레드를 구현할 수 있는 것처럼 말이다.

nodeJS는 크게 자바스크립트 코드와 자바스크립트 엔진인 V8, libuv라이브러리로 이루어진다. 여기서 V8은 자바스크립트 언어를 실행할 수 있는 언어로 전환시키는 인터프리팅 역할을 수행한다. V8에 의해 자바스크립트 언어는 C++로 컨버팅된다. libuv 라이브러리는 V8이 컨버팅한 C++ 코드를 이해하고 실행한다. libuv는 브라우저와 같이 이벤트 루프를 통해 비동기 I/O 작업을 지원한다.

이 libuv에는 스레드풀이라는 것이 존재하는데 이 스레드풀에는 기본적으로 4개의 스레드가 있다.

#### 그럼 node js는 싱글 스레드가 아닌가?

node js는 싱글 스레드 언어이지만 일부 라이브러리는 멀티 스레드 기능을 가지고 있다. node js가 싱글 스레드인 이유는 이벤트 루프는 단 하나이기 때문이다. libuv의 나머지 스레드는 내부적으로 블로킹 되는 작업들(비동기가 필요한 작업들)을 따로 수행하고 이벤트 큐에 등록하는 역할을 한다. 큐에 등록된 이벤트들은 이벤트 루프에 의해 메인 스레드에서 실행된다. 이때 만약 OS가 비동기를 지원할 경우 OS API를 통해 이 작업을 수행하고 그렇지 않은 작업일 경우 워크 스레드가 이를 수행한다.

> 정리하면 node js는 싱글 스레드(이벤트 루프)로 동작하지만 백그라운드에서는 libuv 라이브러리를 통해 멀티 스레드로 동작한다.

참조

- [Javascript와 Nodejs, 그리고 싱글 스레드](https://gyofeel.github.io/js/nodejs/web/Javascript%EC%99%80-Nodejs%EB%8A%94-%EB%AA%A8%EB%91%90-%EC%8B%B1%EA%B8%80-%EC%8A%A4%EB%A0%88%EB%93%9C%EC%97%90%EC%84%9C-%EC%8B%A4%ED%96%89%EB%90%98%EB%8A%94%EA%B0%80/)
- [웹워커-제로초 블로그](https://www.zerocho.com/category/HTML&DOM/post/5a85672158a199001b42ed9c)
- [자바스크립트 엔진](https://corock.tistory.com/467)
- [자바스크립트와 이벤트 루프](https://meetup.toast.com/posts/89)
- [단일 스레드와 멀티 스레드](https://beenlife.tistory.com/114)
