---
title: Nodejs_42 체크인 서버 코드 분석(1)
date: '2021-11-07'
tags: ['Nodejs']
draft: false
summary:
---

## 환경변수

- dotenv, cross-env
- ./.env.sample : (필요한 환경 변수 리스트)
- ./config.json : 개발, 테스트, 배포 등의 실행 분기를 NODE_ENV 라는 변수로 받아 실행)

```js
// config.json

"scripts": {
        "build-ts": "cross-env NODE_ENV=production webpack --config webpack.config.js",
        "test_build-ts": "cross-env NODE_ENV=test webpack --config webpack.config.js",
        "alpha_build-ts": "cross-env NODE_ENV=alpha webpack --config webpack.config.js",
        "build": "npm run build-ts",
        "test_build": "npm run test_build-ts",
        "alpha_build": "npm run alpha_build-ts",
        "serve": "cross-env NODE_ENV=development nodemon --exec ts-node -r tsconfig-paths/register --files ./src/server.ts",
        "start": "npm run serve",
        "test": "cross-env NODE_ENV=devtest  TS_NODE_FILES=true mocha -w  --timeout 5000 -r tsconfig-paths/register -r ts-node/register ./test/**/*.test.ts"
    },
```

- ./src/modules.env.ts : NODE_ENV에 따라 해당하는 .env 파일을 불러오고 이를 새로 만든 env 객체에 주입해 사용한다.

```js
// src/modules.env.ts

if (process.env.NODE_ENV === 'production') {
	dotenv.config({ path: path.join(__dirname, '../../.env.production') });
} else if (process.env.NODE_ENV === 'test') {
	dotenv.config({ path: path.join(__dirname, '../../.env.test') });
}
.
.
.
else {
	throw new Error('process.env.NODE_ENV를 설정하지 않았습니다!');
}

const env {
  port: parseInt(process.env.PORT, 10) || 3000,
  .
  .
  .
}

export default env;
```

## 데이터베이스 생성

- ./src/app.ts : Sequelize로 Mysql로 DB를 연동한다.

```js
// app.ts
import { Sequelize } from './models'

Sequelize()
  .sync({ force: false }) // models에 작성된 모든 테이블 생성, force:false는 기존에 테이블이 있으면 생성하지 않는다. true는 갱신한다.
  .then((v) => {
    try {
      app.emit('dbconnected') // dbconnected 이벤트는 따로 정의해주지 않아도 되는건가?
      console.log('🚀 db connected')
    } catch (error) {
      logger.error(error)
    }
  })
  .catch((err) => {
    console.log(err)
    throw err
  })
```

- ./src/models : DB 모델을 모아놓은 폴더, 테이블은 Users, History, Config로 총 3개. 모델에 필요한 모듈은 `./src/modules` 에 있다.

- Users와 History테이블은 login 키로 연결돼있다.
  아직 서비스를 사용해보지 않아서 각 테이블, 각 컬럼이 정확히 어떤 의미인지 모르겠음

## logger

- models/logger.ts
- tracer, cls-rtracer를 이용해 모든 실행 과정에 log를 남겨 history를 기록한다.
- 생성된 로그들은 ./logs에 저장된다.

## router

-
